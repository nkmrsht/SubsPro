<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubsPro - スマートサブスク管理</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Additional custom styles if needed */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        .gradient-text {
            background: linear-gradient(90deg, #3b82f6, #22c55e);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .auth-modal {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 28rem;
            padding: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-10">
        <!-- Header with Nav -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-12">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <h1 class="text-3xl md:text-5xl font-bold mb-2">
                    <span class="gradient-text">SubsPro</span>
                </h1>
                <p class="text-xl font-semibold text-gray-700">スマートサブスク管理</p>
            </div>
            <div class="flex flex-col md:flex-row items-center space-y-2 md:space-y-0 md:space-x-4">
                <div id="user-controls" class="flex items-center mb-2 md:mb-0 space-x-4">
                    <div id="user-name" class="text-sm font-medium text-gray-700 hidden"></div>
                    <a href="/admin.html" id="admin-link" class="text-indigo-600 hover:text-indigo-800 text-sm hidden">管理者画面</a>
                    <button id="logout-button" onclick="logout()" class="text-indigo-600 hover:text-indigo-800 text-sm hidden">ログアウト</button>
                </div>
                <div class="flex items-center space-x-2">
                    <label for="display-currency" class="text-sm font-medium text-gray-600">表示通貨:</label>
                    <select 
                        id="display-currency" 
                        class="text-sm border border-gray-300 rounded-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="JPY">日本円 (¥)</option>
                        <option value="USD">米ドル ($)</option>
                    </select>
                </div>

            </div>
        </header>

        <!-- Main Content -->
        <div id="main-content">
            <!-- Will be shown only when user is logged in -->
        </div>

        <!-- Footer -->
        <footer class="text-center text-gray-500 text-sm mt-12 pb-6">
            <div class="flex items-center justify-center mb-2">
                <span class="gradient-text font-bold text-lg mr-1">SubsPro</span>
                <span>by</span>
            </div>
            <p>© 2025 Lobbdesign LLC</p>
        </footer>
    </div>

    <!-- Auth Modal Template -->
    <template id="auth-modal-template">
        <div class="auth-overlay">
            <div class="auth-modal">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800" id="auth-modal-title">アカウント登録</h2>
                    <button id="auth-modal-close" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <form id="auth-form" class="space-y-4">
                    <div>
                        <label for="auth-username" class="block text-sm font-medium text-gray-700 mb-1">ユーザー名</label>
                        <input 
                            type="text" 
                            id="auth-username" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                        >
                    </div>
                    <div>
                        <label for="auth-password" class="block text-sm font-medium text-gray-700 mb-1">パスワード</label>
                        <input 
                            type="password" 
                            id="auth-password" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                        >
                    </div>
                    <div id="auth-error" class="text-red-500 text-sm hidden"></div>
                    <div class="flex space-x-2">
                        <button 
                            type="submit" 
                            id="auth-submit"
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md transition duration-300"
                        >
                            登録
                        </button>
                    </div>
                    <div class="text-center text-sm text-gray-600">
                        <span id="auth-switch-text">アカウントをお持ちの方は</span>
                        <button type="button" id="auth-switch-btn" class="text-blue-500 hover:text-blue-700">ログイン</button>
                    </div>
                </form>
            </div>
        </div>
    </template>

    <!-- Main Content Template -->
    <template id="main-content-template">
        <!-- Input Form Card -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8 max-w-md mx-auto">
            <h2 class="text-xl font-semibold text-gray-800 mb-4" id="form-title">新規サブスクリプション</h2>
            <form id="subscription-form" class="space-y-4">
                <input type="hidden" id="edit-id" value="">
                <div>
                    <label for="subscription-name" class="block text-sm font-medium text-gray-700 mb-1">サブスク名</label>
                    <input 
                        type="text" 
                        id="subscription-name" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    >
                </div>
                <div>
                    <label for="subscription-fee" class="block text-sm font-medium text-gray-700 mb-1">料金</label>
                    <div class="flex">
                        <input 
                            type="number" 
                            id="subscription-fee" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            min="0" 
                            step="1"
                            required
                        >
                        <select 
                            id="subscription-currency" 
                            class="bg-gray-100 px-3 py-2 border border-gray-300 rounded-r-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="JPY">円</option>
                            <option value="USD">$</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="payment-cycle" class="block text-sm font-medium text-gray-700 mb-1">支払いサイクル</label>
                    <select 
                        id="payment-cycle" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="monthly">月払い</option>
                        <option value="yearly">年払い</option>
                    </select>
                </div>
                
                <!-- 支払い日入力フィールド（動的に切り替わる） -->
                <div id="monthly-payment-date-container">
                    <label for="monthly-payment-date" class="block text-sm font-medium text-gray-700 mb-1">支払い日（毎月）</label>
                    <input 
                        type="number" 
                        id="monthly-payment-date" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        min="1" 
                        max="31" 
                        placeholder="1〜31" 
                        required
                    >
                </div>
                
                <div id="yearly-payment-date-container" class="hidden space-y-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">支払い日（年間）</label>
                    <div class="flex space-x-2">
                        <div class="w-1/2">
                            <input 
                                type="number" 
                                id="yearly-payment-month" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                min="1" 
                                max="12" 
                                placeholder="月" 
                                required
                            >
                        </div>
                        <div class="w-1/2">
                            <input 
                                type="number" 
                                id="yearly-payment-day" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                min="1" 
                                max="31" 
                                placeholder="日" 
                                required
                            >
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-2">
                    <button 
                        type="submit" 
                        id="submit-button"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md transition duration-300"
                    >
                        追加
                    </button>
                    <button 
                        type="button" 
                        id="cancel-button"
                        class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-300 hidden"
                    >
                        キャンセル
                    </button>
                </div>
            </form>
        </div>

        <!-- Subscription List -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8 max-w-5xl mx-auto overflow-hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">サブスクリプション一覧</h2>
            
            <div class="overflow-x-auto">
                <table id="subscription-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">サブスク名</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">料金</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">通貨</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">支払いサイクル</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">支払い日</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- Subscription rows will be added here by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Empty state message -->
            <div id="empty-state" class="py-8 text-center text-gray-500">
                サブスクリプションはまだ登録されていません
            </div>
        </div>

        <!-- Monthly Payment Summary -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8 max-w-5xl mx-auto">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">月ごとの支払い合計</h2>
            <div id="monthly-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Monthly summaries will be added here by JavaScript -->
            </div>
        </div>

        <!-- Total Monthly Cost -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8 max-w-5xl mx-auto">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800">月換算の合計</h2>
                <p id="total-cost" class="text-2xl font-bold text-blue-600">0円</p>
            </div>
        </div>
    </template>

    <!-- User Controls (Logged out) Template -->
    <template id="user-controls-logged-out-template">
        <div class="flex space-x-2">
            <button 
                id="login-button" 
                class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md transition duration-300"
            >
                ログイン
            </button>
            <button 
                id="register-button" 
                class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-md transition duration-300"
            >
                新規登録
            </button>
        </div>
    </template>

    <!-- User Controls (Logged in) Template -->
    <template id="user-controls-logged-in-template">
        <div class="flex items-center space-x-4">
            <div class="text-right">
                <p class="text-sm text-gray-600">ログイン中：</p>
                <p class="font-medium text-gray-800" id="username-display"></p>
            </div>
            <a 
                href="/admin.html" 
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md transition duration-300"
            >
                管理画面
            </a>
            <button 
                id="logout-button" 
                class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-300"
            >
                ログアウト
            </button>
        </div>
    </template>

    <!-- Guest Welcome Template -->
    <template id="guest-welcome-template">
        <div class="bg-white rounded-lg shadow-md p-8 max-w-3xl mx-auto text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">SubsProへようこそ！</h2>
            <p class="text-lg text-gray-600 mb-6">
                サブスクリプション管理をもっと簡単に。<br>
                アカウントを作成すると、複数のデバイスからアクセスできます。
            </p>
            <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4">
                <button 
                    id="welcome-register-button" 
                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300"
                >
                    アカウント作成
                </button>
                <button 
                    id="welcome-login-button" 
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300"
                >
                    ログイン
                </button>
                <button 
                    id="welcome-offline-button" 
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition duration-300"
                >
                    オフラインで使用
                </button>
            </div>
        </div>
    </template>

    <script>
        // Storage key for localStorage
        const STORAGE_KEY = 'lobbdesign_subs_v1';
        
        // Current user data
        let currentUser = null;
        
        // 為替レート
        let exchangeRates = {
            USD_JPY: 130, // デフォルト値
            JPY_USD: 0.0077, // デフォルト値
            timestamp: null,
            date: null
        };
        
        // 表示通貨 ('JPY' または 'USD')
        let displayCurrency = 'JPY';
        
        // Subscription data array
        let subscriptions = [];
        
        // DOM Elements to be initialized after content is rendered
        let subscriptionForm, formTitle, submitButton, cancelButton;
        let editIdInput, subscriptionTable, tableBody, emptyState;
        let totalCostElement, paymentCycleSelect;
        let monthlyPaymentDateContainer, yearlyPaymentDateContainer;
        let monthlyPaymentDate, yearlyPaymentMonth, yearlyPaymentDay;
        let monthlySummary, subscriptionCurrency, displayCurrencySelector;
        
        // 為替レートを取得する関数
        async function fetchExchangeRates() {
            try {
                const response = await fetch('/api/exchange-rate');
                if (response.ok) {
                    const data = await response.json();
                    exchangeRates = data;
                    console.log('為替レート取得成功:', exchangeRates);
                    // 表示を更新
                    renderSubscriptions();
                    updateMonthlySummary();
                    updateTotalCost();
                } else {
                    console.error('為替レート取得エラー:', response.statusText);
                }
            } catch (error) {
                console.error('為替レート取得エラー:', error);
            }
        }
        
        // 通貨変換関数
        function convertCurrency(amount, fromCurrency, toCurrency) {
            if (fromCurrency === toCurrency) {
                return amount;
            }
            
            if (fromCurrency === 'JPY' && toCurrency === 'USD') {
                return amount * exchangeRates.JPY_USD;
            } else if (fromCurrency === 'USD' && toCurrency === 'JPY') {
                return amount * exchangeRates.USD_JPY;
            }
            
            return amount;
        }
        
        // 金額を表示用にフォーマットする関数
        function formatCurrency(amount, currency) {
            if (currency === 'JPY') {
                return Math.round(amount).toLocaleString() + '円';
            } else if (currency === 'USD') {
                return '$' + amount.toFixed(2).toLocaleString();
            }
            return amount.toString();
        }
        
        // 通貨表示を切り替える関数
        function updateDisplayCurrency(currency) {
            displayCurrency = currency;
            if (displayCurrencySelector) {
                displayCurrencySelector.value = currency;
            }
            renderSubscriptions();
            updateMonthlySummary();
            updateTotalCost();
        }
        
        // Initialize UI
        function initUI() {
            const userControlsContainer = document.getElementById('user-controls');
            const mainContentContainer = document.getElementById('main-content');
            
            // Clear containers
            userControlsContainer.innerHTML = '';
            mainContentContainer.innerHTML = '';
            
            if (currentUser) {
                // User is logged in, show user controls and main content
                const userControlsTemplate = document.getElementById('user-controls-logged-in-template');
                userControlsContainer.appendChild(userControlsTemplate.content.cloneNode(true));
                
                // Set username
                document.getElementById('username-display').textContent = currentUser.username;
                
                // Set logout button handler
                document.getElementById('logout-button').addEventListener('click', logout);
                
                // Show main content
                const mainContentTemplate = document.getElementById('main-content-template');
                mainContentContainer.appendChild(mainContentTemplate.content.cloneNode(true));
                
                // Initialize main content elements
                initMainContentElements();
                
                // Load subscriptions for user
                loadSubscriptions();
            } else {
                // User is logged out, show login/register buttons and welcome message
                const userControlsTemplate = document.getElementById('user-controls-logged-out-template');
                userControlsContainer.appendChild(userControlsTemplate.content.cloneNode(true));
                
                // Set login/register button handlers
                document.getElementById('login-button').addEventListener('click', () => showAuthModal('login'));
                document.getElementById('register-button').addEventListener('click', () => showAuthModal('register'));
                
                // Show welcome message
                const guestWelcomeTemplate = document.getElementById('guest-welcome-template');
                mainContentContainer.appendChild(guestWelcomeTemplate.content.cloneNode(true));
                
                // Set welcome button handlers
                document.getElementById('welcome-register-button').addEventListener('click', () => showAuthModal('register'));
                document.getElementById('welcome-login-button').addEventListener('click', () => showAuthModal('login'));
                document.getElementById('welcome-offline-button').addEventListener('click', useOfflineMode);
            }
        }
        
        // Initialize main content elements
        function initMainContentElements() {
            subscriptionForm = document.getElementById('subscription-form');
            formTitle = document.getElementById('form-title');
            submitButton = document.getElementById('submit-button');
            cancelButton = document.getElementById('cancel-button');
            editIdInput = document.getElementById('edit-id');
            subscriptionTable = document.getElementById('subscription-table');
            tableBody = subscriptionTable.querySelector('tbody');
            emptyState = document.getElementById('empty-state');
            totalCostElement = document.getElementById('total-cost');
            paymentCycleSelect = document.getElementById('payment-cycle');
            monthlyPaymentDateContainer = document.getElementById('monthly-payment-date-container');
            yearlyPaymentDateContainer = document.getElementById('yearly-payment-date-container');
            monthlyPaymentDate = document.getElementById('monthly-payment-date');
            yearlyPaymentMonth = document.getElementById('yearly-payment-month');
            yearlyPaymentDay = document.getElementById('yearly-payment-day');
            monthlySummary = document.getElementById('monthly-summary');
            
            // Add event listeners
            paymentCycleSelect.addEventListener('change', togglePaymentDateFields);
            
            // 通貨関連の要素を初期化
            subscriptionCurrency = document.getElementById('subscription-currency');
            displayCurrencySelector = document.getElementById('display-currency');
            
            // 表示通貨切り替えイベントを設定
            if (displayCurrencySelector) {
                displayCurrencySelector.addEventListener('change', function(e) {
                    updateDisplayCurrency(e.target.value);
                });
            }
            
            // 為替レートを取得
            fetchExchangeRates();
            
            // Form submission
            subscriptionForm.addEventListener('submit', handleFormSubmit);
            
            // Cancel button
            cancelButton.addEventListener('click', resetForm);
            
            // Table actions (Edit and Delete)
            tableBody.addEventListener('click', handleTableActions);
            
            // Initialize form fields
            togglePaymentDateFields();
        }
        
        // Show the authentication modal
        function showAuthModal(mode) {
            // First remove any existing modals
            const existingModal = document.querySelector('.auth-overlay');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Clone the modal template
            const modalTemplate = document.getElementById('auth-modal-template');
            const modalNode = modalTemplate.content.cloneNode(true);
            document.body.appendChild(modalNode);
            
            // Get elements
            const modal = document.querySelector('.auth-overlay');
            const modalTitle = document.getElementById('auth-modal-title');
            const form = document.getElementById('auth-form');
            const submitButton = document.getElementById('auth-submit');
            const switchText = document.getElementById('auth-switch-text');
            const switchButton = document.getElementById('auth-switch-btn');
            const closeButton = document.getElementById('auth-modal-close');
            
            // Set mode
            if (mode === 'login') {
                modalTitle.textContent = 'ログイン';
                submitButton.textContent = 'ログイン';
                switchText.textContent = 'アカウントをお持ちでない方は';
                switchButton.textContent = '新規登録';
                switchButton.addEventListener('click', () => showAuthModal('register'));
            } else {
                modalTitle.textContent = 'アカウント登録';
                submitButton.textContent = '登録';
                switchText.textContent = 'アカウントをお持ちの方は';
                switchButton.textContent = 'ログイン';
                switchButton.addEventListener('click', () => showAuthModal('login'));
            }
            
            // Form submission
            form.addEventListener('submit', (event) => {
                event.preventDefault();
                
                const username = document.getElementById('auth-username').value;
                const password = document.getElementById('auth-password').value;
                
                if (mode === 'login') {
                    login(username, password);
                } else {
                    register(username, password);
                }
            });
            
            // Close button
            closeButton.addEventListener('click', () => {
                modal.remove();
            });
            
            // Close on outside click
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Use offline mode
        function useOfflineMode() {
            // Load subscriptions from localStorage
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                subscriptions = JSON.parse(savedData);
            }
            
            // Initialize UI as if user is logged in, but without actual user
            currentUser = { id: 'offline', username: 'オフラインモード' };
            initUI();
        }
        
        // オンラインモードを使用する
        function useOnlineMode() {
            // UI初期化
            initUI();
            
            // オンラインデータを取得
            fetchSubscriptions();
        }
        
        // サーバーからサブスクリプションデータを取得
        async function fetchSubscriptions() {
            try {
                const response = await fetch('/api/subscriptions', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    subscriptions = data;
                    renderSubscriptionList();
                    updateMonthlySummary();
                    saveTempDataToLocalStorage(); // バックアップとしてローカルにも保存
                } else {
                    console.error('サブスクリプションの取得に失敗しました:', response.status);
                    showError('サーバーからデータを取得できませんでした。');
                }
            } catch (error) {
                console.error('サブスクリプション取得エラー:', error);
                showError('通信エラーが発生しました。');
            }
        }
        
        // オンラインデータをローカルにもバックアップ
        function saveTempDataToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEY + '_online_backup', JSON.stringify(subscriptions));
            } catch (error) {
                console.error('ローカルストレージへの保存エラー:', error);
            }
        }
        
        // エラーメッセージを表示
        function showError(message, duration = 3000) {
            const errorElement = document.createElement('div');
            errorElement.className = 'fixed bottom-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded';
            errorElement.textContent = message;
            
            document.body.appendChild(errorElement);
            
            // 一定時間後に自動で消える
            setTimeout(() => {
                errorElement.remove();
            }, duration);
        }
        
        // Register new user
        async function register(username, password) {
            const errorDisplay = document.getElementById('auth-error');
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Registration successful
                    currentUser = data.user;
                    
                    // Close the modal
                    document.querySelector('.auth-overlay').remove();
                    
                    // Import data from localStorage if any
                    const localData = localStorage.getItem(STORAGE_KEY);
                    if (localData) {
                        const localSubscriptions = JSON.parse(localData);
                        if (localSubscriptions.length > 0) {
                            // Ask user if they want to import
                            if (confirm('ローカルに保存されているサブスクリプションデータが見つかりました。アカウントに取り込みますか？')) {
                                await importLocalSubscriptions(localSubscriptions);
                            }
                        }
                    }
                    
                    // Initialize UI
                    initUI();
                } else {
                    // Show error
                    errorDisplay.textContent = data.error || 'アカウント登録に失敗しました。';
                    errorDisplay.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Registration error:', error);
                errorDisplay.textContent = 'サーバーに接続できませんでした。';
                errorDisplay.classList.remove('hidden');
            }
        }
        
        // Login user
        async function login(username, password) {
            const errorDisplay = document.getElementById('auth-error');
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Login successful
                    currentUser = data.user;
                    
                    // Close the modal
                    document.querySelector('.auth-overlay').remove();
                    
                    // Initialize UI
                    initUI();
                } else {
                    // Show error
                    errorDisplay.textContent = data.error || 'ログインに失敗しました。';
                    errorDisplay.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDisplay.textContent = 'サーバーに接続できませんでした。';
                errorDisplay.classList.remove('hidden');
            }
        }
        
        // Logout user
        async function logout() {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            // Clear current user
            currentUser = null;
            
            // Clear subscriptions
            subscriptions = [];
            
            // Initialize UI
            initUI();
        }
        
        // Import local subscriptions to server
        async function importLocalSubscriptions(localSubscriptions) {
            try {
                for (const subscription of localSubscriptions) {
                    await createSubscription(
                        subscription.name,
                        subscription.fee,
                                currency,
                        subscription.cycle,
                        subscription.paymentDay,
                        subscription.paymentMonth
                    );
                }
                
                // Clear localStorage after import
                localStorage.removeItem(STORAGE_KEY);
            } catch (error) {
                console.error('Error importing subscriptions:', error);
                alert('サブスクリプションのインポートに失敗しました。');
            }
        }
        
        // Toggle payment date fields based on cycle
        function togglePaymentDateFields() {
            if (paymentCycleSelect.value === 'monthly') {
                monthlyPaymentDateContainer.classList.remove('hidden');
                yearlyPaymentDateContainer.classList.add('hidden');
                monthlyPaymentDate.setAttribute('required', '');
                yearlyPaymentMonth.removeAttribute('required');
                yearlyPaymentDay.removeAttribute('required');
            } else {
                monthlyPaymentDateContainer.classList.add('hidden');
                yearlyPaymentDateContainer.classList.remove('hidden');
                monthlyPaymentDate.removeAttribute('required');
                yearlyPaymentMonth.setAttribute('required', '');
                yearlyPaymentDay.setAttribute('required', '');
            }
        }
        
        // この関数は formatCurrency に置き換えられました
        
        // Format payment date based on cycle
        function formatPaymentDate(subscription) {
            if (subscription.cycle === 'monthly') {
                return `毎月${subscription.paymentDay}日`;
            } else {
                return `${subscription.paymentMonth}月${subscription.paymentDay}日`;
            }
        }
        
        // Calculate monthly cost from all subscriptions
        function calculateMonthlyTotal() {
            return subscriptions.reduce((total, subscription) => {
                const origCurrency = subscription.currency || 'JPY';
                const fee = parseFloat(subscription.fee);
                
                // 全て表示通貨に変換
                const convertedFee = convertCurrency(fee, origCurrency, displayCurrency);
                
                // Convert yearly payments to monthly
                return total + (subscription.cycle === 'yearly' ? convertedFee / 12 : convertedFee);
            }, 0);
        }
        
        // Update the total cost display
        function updateTotalCost() {
            const monthlyTotal = calculateMonthlyTotal();
            totalCostElement.textContent = formatCurrency(monthlyTotal, displayCurrency);
        }
        
        // Calculate total payments by month
        function calculateMonthlyPayments() {
            const months = {
                1: '1月', 2: '2月', 3: '3月', 4: '4月', 
                5: '5月', 6: '6月', 7: '7月', 8: '8月',
                9: '9月', 10: '10月', 11: '11月', 12: '12月'
            };
            
            const monthlyPayments = {};
            
            // Initialize all months with 0
            for (let i = 1; i <= 12; i++) {
                monthlyPayments[i] = 0;
            }
            
            // Add each subscription's payment to appropriate month(s)
            subscriptions.forEach(subscription => {
                const origCurrency = subscription.currency || 'JPY';
                const fee = parseFloat(subscription.fee);
                // 表示通貨に変換
                const convertedFee = convertCurrency(fee, origCurrency, displayCurrency);
                
                if (subscription.cycle === 'monthly') {
                    // Monthly payments affect all months equally
                    for (let i = 1; i <= 12; i++) {
                        monthlyPayments[i] += convertedFee;
                    }
                } else {
                    // Yearly payments only affect the specific month
                    const month = parseInt(subscription.paymentMonth);
                    monthlyPayments[month] += convertedFee;
                }
            });
            
            // Format the results
            const result = [];
            for (let i = 1; i <= 12; i++) {
                result.push({
                    month: months[i],
                    total: monthlyPayments[i]
                });
            }
            
            return result;
        }
        
        // Update the monthly payment summary
        function updateMonthlySummary() {
            const monthlyPayments = calculateMonthlyPayments();
            monthlySummary.innerHTML = '';
            
            monthlyPayments.forEach(month => {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'bg-gray-100 p-3 rounded-md';
                monthDiv.innerHTML = `
                    <div class="text-sm font-medium text-gray-700">${month.month}</div>
                    <div class="text-lg font-bold ${month.total > 0 ? 'text-blue-600' : 'text-gray-400'}">${formatCurrency(month.total, displayCurrency)}</div>
                `;
                monthlySummary.appendChild(monthDiv);
            });
        }
        
        // Save subscriptions to localStorage (for offline mode)
        function saveSubscriptions() {
            if (currentUser && currentUser.id === 'offline') {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(subscriptions));
            }
        }
        
        // Load subscriptions from server or localStorage
        async function loadSubscriptions() {
            if (currentUser) {
                if (currentUser.id === 'offline') {
                    // In offline mode, data is already loaded from localStorage
                    renderSubscriptions();
                } else {
                    // Online mode, load from server
                    try {
                        const response = await fetch('/api/subscriptions', {
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            subscriptions = await response.json();
                            renderSubscriptions();
                        } else {
                            console.error('Failed to load subscriptions');
                        }
                    } catch (error) {
                        console.error('Error loading subscriptions:', error);
                    }
                }
            }
        }
        
        // Create a new subscription
        async function createSubscription(name, fee, currency, cycle, paymentDay, paymentMonth = null) {
            if (currentUser) {
                if (currentUser.id === 'offline') {
                    // Offline mode, save to localStorage
                    const newSubscription = {
                        id: Date.now().toString(),
                        name,
                        fee,
                                currency,
                        currency,
                        cycle,
                        paymentDay,
                        paymentMonth
                    };
                    
                    subscriptions.push(newSubscription);
                    saveSubscriptions();
                    renderSubscriptions();
                    return newSubscription;
                } else {
                    // Online mode, save to server
                    try {
                        const response = await fetch('/api/subscriptions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                name,
                                fee,
                                currency,
                                currency,
                                cycle,
                                paymentDay,
                                paymentMonth
                            }),
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const newSubscription = await response.json();
                            subscriptions.push(newSubscription);
                            renderSubscriptions();
                            return newSubscription;
                        } else {
                            console.error('Failed to create subscription');
                            return null;
                        }
                    } catch (error) {
                        console.error('Error creating subscription:', error);
                        return null;
                    }
                }
            }
        }
        
        // Update an existing subscription
        async function updateSubscription(id, name, fee, currency, cycle, paymentDay, paymentMonth = null) {
            if (currentUser) {
                if (currentUser.id === 'offline') {
                    // Offline mode, update in localStorage
                    const index = subscriptions.findIndex(sub => sub.id === id);
                    
                    if (index !== -1) {
                        subscriptions[index] = {
                            ...subscriptions[index],
                            name,
                            fee,
                                currency,
                            currency,
                            cycle,
                            paymentDay,
                            paymentMonth
                        };
                        
                        saveSubscriptions();
                        renderSubscriptions();
                        return subscriptions[index];
                    }
                    return null;
                } else {
                    // Online mode, update on server
                    try {
                        const response = await fetch(`/api/subscriptions/${id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                name,
                                fee,
                                currency,
                                cycle,
                                paymentDay,
                                paymentMonth
                            }),
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const updatedSubscription = await response.json();
                            const index = subscriptions.findIndex(sub => sub.id === id);
                            if (index !== -1) {
                                subscriptions[index] = updatedSubscription;
                            }
                            renderSubscriptions();
                            return updatedSubscription;
                        } else {
                            console.error('Failed to update subscription');
                            return null;
                        }
                    } catch (error) {
                        console.error('Error updating subscription:', error);
                        return null;
                    }
                }
            }
        }
        
        // Delete a subscription
        async function removeSubscription(id) {
            if (currentUser) {
                if (currentUser.id === 'offline') {
                    // Offline mode, remove from localStorage
                    subscriptions = subscriptions.filter(sub => sub.id !== id);
                    saveSubscriptions();
                    renderSubscriptions();
                } else {
                    // Online mode, delete from server
                    try {
                        const response = await fetch(`/api/subscriptions/${id}`, {
                            method: 'DELETE',
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            subscriptions = subscriptions.filter(sub => sub.id !== id);
                            renderSubscriptions();
                        } else {
                            console.error('Failed to delete subscription');
                        }
                    } catch (error) {
                        console.error('Error deleting subscription:', error);
                    }
                }
            }
        }
        
        // Get subscription by ID
        function getSubscription(id) {
            return subscriptions.find(sub => sub.id === id) || null;
        }
        
        // Set the form to edit mode for a specific subscription
        function editSubscription(id) {
            const subscription = getSubscription(id);
            
            if (subscription) {
                // Update form UI
                formTitle.textContent = 'サブスクリプションを編集';
                submitButton.textContent = '更新';
                cancelButton.classList.remove('hidden');
                
                // Set form values
                editIdInput.value = subscription.id;
                document.getElementById('subscription-name').value = subscription.name;
                document.getElementById('subscription-fee').value = subscription.fee;
                document.getElementById('subscription-currency').value = subscription.currency || 'JPY';
                document.getElementById('payment-cycle').value = subscription.cycle;
                
                // Set payment date fields
                if (subscription.cycle === 'monthly') {
                    document.getElementById('monthly-payment-date').value = subscription.paymentDay;
                } else {
                    document.getElementById('yearly-payment-month').value = subscription.paymentMonth;
                    document.getElementById('yearly-payment-day').value = subscription.paymentDay;
                }
                
                // Toggle payment date fields
                togglePaymentDateFields();
                
                // Scroll to form
                document.getElementById('subscription-form').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // Reset the form to add mode
        function resetForm() {
            // Reset form UI
            formTitle.textContent = '新規サブスクリプション';
            submitButton.textContent = '追加';
            cancelButton.classList.add('hidden');
            
            // Clear form values
            editIdInput.value = '';
            subscriptionForm.reset();
            
            // Set default payment cycle
            paymentCycleSelect.value = 'monthly';
            
            // Show monthly payment date field
            togglePaymentDateFields();
        }
        
        // Handle form submission
        function handleFormSubmit(event) {
            event.preventDefault();
            
            const nameInput = document.getElementById('subscription-name');
            const feeInput = document.getElementById('subscription-fee');
            const cycleSelect = document.getElementById('payment-cycle');
            const currencySelect = document.getElementById('subscription-currency');
            
            const name = nameInput.value.trim();
            const fee = parseFloat(feeInput.value);
            const cycle = cycleSelect.value;
            const currency = currencySelect.value;
            
            // Get payment date based on cycle
            let paymentDay, paymentMonth;
            
            if (cycle === 'monthly') {
                paymentDay = parseInt(monthlyPaymentDate.value);
                paymentMonth = null;
            } else {
                paymentDay = parseInt(yearlyPaymentDay.value);
                paymentMonth = parseInt(yearlyPaymentMonth.value);
            }
            
            if (name && !isNaN(fee) && fee >= 0 && !isNaN(paymentDay)) {
                // Check if we're editing or adding
                const editId = editIdInput.value;
                
                if (editId) {
                    // Update existing subscription
                    updateSubscription(editId, name, fee, currency, cycle, paymentDay, paymentMonth);
                    resetForm();
                } else {
                    // Add new subscription
                    createSubscription(name, fee, currency, cycle, paymentDay, paymentMonth);
                    
                    // Reset form but keep payment cycle selection
                    const currentCycle = cycleSelect.value;
                    nameInput.value = '';
                    feeInput.value = '';
                    cycleSelect.value = currentCycle;
                    
                    if (cycle === 'monthly') {
                        monthlyPaymentDate.value = '';
                    } else {
                        yearlyPaymentMonth.value = '';
                        yearlyPaymentDay.value = '';
                    }
                    
                    nameInput.focus();
                }
            }
        }
        
        // Handle table actions (Edit and Delete)
        function handleTableActions(event) {
            // Check for edit button click
            const editButton = event.target.closest('button[data-edit-id]');
            if (editButton) {
                const id = editButton.getAttribute('data-edit-id');
                editSubscription(id);
                return;
            }
            
            // Check for delete button click
            const deleteButton = event.target.closest('button[data-delete-id]');
            if (deleteButton) {
                const id = deleteButton.getAttribute('data-delete-id');
                removeSubscription(id);
                return;
            }
        }

        // Sort subscriptions based on criteria
        function sortSubscriptions() {
            // Sort the subscriptions array
            subscriptions.sort((a, b) => {
                // Priority 1: Payment cycle (yearly first, monthly second)
                if (a.cycle !== b.cycle) {
                    return a.cycle === 'yearly' ? -1 : 1;
                }
                
                // Priority 2: Payment date
                if (a.cycle === 'monthly' && b.cycle === 'monthly') {
                    // For monthly payments, sort by day
                    return a.paymentDay - b.paymentDay;
                } else if (a.cycle === 'yearly' && b.cycle === 'yearly') {
                    // For yearly payments, sort by month then day
                    if (a.paymentMonth !== b.paymentMonth) {
                        return a.paymentMonth - b.paymentMonth;
                    }
                    return a.paymentDay - b.paymentDay;
                }
                
                // If all else is equal, sort by name
                return a.name.localeCompare(b.name);
            });
        }
        
        // Render subscriptions to the table
        function renderSubscriptions() {
            // Sort the subscriptions first
            sortSubscriptions();
            
            // Clear the table first
            tableBody.innerHTML = '';
            
            // Show/hide empty state
            if (subscriptions.length === 0) {
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
            }
            
            // Add subscription rows
            subscriptions.forEach(subscription => {
                const row = document.createElement('tr');
                
                // 元の通貨から表示通貨に変換
                const origCurrency = subscription.currency || 'JPY';
                const displayAmount = convertCurrency(subscription.fee, origCurrency, displayCurrency);
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${subscription.name}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${formatCurrency(displayAmount, displayCurrency)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${origCurrency === 'JPY' ? 'bg-indigo-100 text-indigo-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${origCurrency}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${subscription.cycle === 'monthly' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                            ${subscription.cycle === 'monthly' ? '月払い' : '年払い'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${formatPaymentDate(subscription)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <button 
                            class="text-blue-600 hover:text-blue-900 focus:outline-none mr-3"
                            data-edit-id="${subscription.id}"
                        >
                            ✎
                        </button>
                        <button 
                            class="text-red-600 hover:text-red-900 focus:outline-none"
                            data-delete-id="${subscription.id}"
                        >
                            ✕
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Update the total cost and monthly summary
            updateTotalCost();
            updateMonthlySummary();
        }

        // Check if user is already logged in
        async function checkAuth() {
            try {
                console.log('Checking authentication status...');
                const response = await fetch('/api/user', {
                    credentials: 'include'
                });
                
                console.log('Auth response status:', response.status);
                
                if (response.ok) {
                    try {
                        const responseText = await response.text();
                        try {
                            // レスポンスがJSONかどうか確認
                            currentUser = JSON.parse(responseText);
                            console.log('User is logged in:', currentUser);
                        } catch (jsonError) {
                            console.error('JSON parse error:', jsonError);
                            // JSONでない場合はログアウト状態とみなす
                            currentUser = null;
                        }
                    } catch (textError) {
                        console.error('Response text error:', textError);
                        currentUser = null;
                    }
                } else {
                    console.log('User is not logged in');
                    currentUser = null;
                }
            } catch (error) {
                console.error('Auth check error:', error);
                currentUser = null;
            }
            
            console.log('Initializing UI...');
            // ログイン状態に応じてモードを選択
            if (currentUser) {
                // ログイン中はオンラインモード
                useOnlineMode();
            } else {
                // 未ログイン時はオフラインモード
                useOfflineMode();
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });
    </script>
</body>
</html>
